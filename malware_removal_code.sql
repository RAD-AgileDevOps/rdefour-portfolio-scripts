/*

	Data Engineer: Roger De Four
	Date: 2023-10-01
	Description:Amendment made to code to create a table object in the database for reference purooses , as I am using VIEWS - thus
				rendering the list dynamic

 */
DROP TABLE tbl_malware_removal_code_output ; 
CREATE TABLE IF NOT EXISTS tbl_malware_removal_code_output

AS
SELECT 


	-- orig_20230926_b4_parsing.*
	orig_20230926_b4_parsing.logid ,
	orig_20230926_b4_parsing.column1_original ,
	
	-- concat('rm -rvf ' ,'  ' ,orig_20230926_b4_parsing.column1_original) as "Linux_removal_code" ,
	
	-- RIGHT( orig_20230926_b4_parsing.column1_original, 3),
	concat('rm -rvf ' ,'  ' ,LEFT(orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1)))  as "Linux_removal_code" ,
	
	--concat('zip ' ,'  ' ,LEFT(orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1)))  as "Linux_removal_code"
	-- --LEFT((orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1)), (Position('/.htacce' in LEFT(orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1))))) 
	
	-- --Position('/.htacce' in LEFT(orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1)))  AS  "choice1" ,
	-- --Position('/upl.php' in LEFT(orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1)))  AS  "choice2" ,
	
	CASE 
	
		-- -- .htaccess
	   WHEN (RIGHT(orig_20230926_b4_parsing.column1_original , 10) = '.htaccess:')  then concat('zip ', (LEFT( orig_20230926_b4_parsing.column1_original ,(Position('/.htacce' in LEFT(orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1)))) )), '.zip ' ,'  ' , (LEFT( orig_20230926_b4_parsing.column1_original ,(Position('/.htacce' in LEFT(orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1)))) )))
	   -- --upl.php
	   --WHEN (RIGHT(orig_20230926_b4_parsing.column1_original , 8) = 'upl.php:')  then (LEFT( orig_20230926_b4_parsing.column1_original ,(Position('/upl.php' in LEFT(orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1)))) ))
	   WHEN (RIGHT(orig_20230926_b4_parsing.column1_original , 8) = 'upl.php:')  then concat('zip ', (LEFT( orig_20230926_b4_parsing.column1_original ,(Position('/upl.php' in LEFT(orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1)))) )), '.zip ' ,'  ' , (LEFT( orig_20230926_b4_parsing.column1_original ,(Position('/upl.php' in LEFT(orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1)))) ))         )
	   
	   WHEN (RIGHT(orig_20230926_b4_parsing.column1_original , 9) = 'task.php:')  then concat('zip ', (LEFT( orig_20230926_b4_parsing.column1_original ,(Position('/task.php' in LEFT(orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1)))) )), '.zip ' ,'  ' , (LEFT( orig_20230926_b4_parsing.column1_original ,(Position('/task.php' in LEFT(orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1)))) ))         )
	END as Outcome   
	
			 
-- I commmented out the 'workings' as I felt it was now extraneous information
-- it wwas just working to validate anf generate the malware pathway, for easier 
-- deletion of the malware utilizing the Linux 'rm' command
/*mwd_before.level1,
    mwd_before.level2,
    mwd_before.level3,
    mwd_before.level4,
    scr_for_matching.logid,
    scr_for_matching.col1,
    scr_for_matching.col2,
    scr_for_matching.col3,
    scr_for_matching.col4,
    scr_for_matching.col5,
    scr_for_matching.col6,
    scr_for_matching.col7,
    scr_for_matching.col8,
    scr_for_matching.col9,
    scr_for_matching.col10,
    scr_for_matching.col11,
    scr_for_matching.col12,
    scr_for_matching.col13,
    scr_for_matching.col14,
    scr_for_matching.col15,
    scr_for_matching.col16,
    scr_for_matching.col17,
    scr_for_matching.col18,
    scr_for_matching.col19,
    scr_for_matching.col20,
    scr_for_matching.col21*/
   FROM vw_malware_awaiting_deletion mwd_before
     JOIN scanreport_redone.tbl_scanreport_20230926 scr_for_matching ON mwd_before.logid = scr_for_matching.logid
	 
INNER JOIN 	 public.tbl_original_dataset_scanreport_20230926 as orig_20230926_b4_parsing
ON

mwd_before.logid = orig_20230926_b4_parsing.logid

	 
-- WHERE 	Position('/.htacce' in LEFT(orig_20230926_b4_parsing.column1_original, (LENGTH(orig_20230926_b4_parsing.column1_original) -1))) = 0
-- WHERE orig_20230926_b4_parsing.column1_original ILIKE '%.php%'	 
	 ;
